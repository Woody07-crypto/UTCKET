<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Concierto</title>
    <link rel="stylesheet" href="CSS/empleado.css">
    <link rel="stylesheet" href="CSS/nav.css">
    <link rel="stylesheet" href="CSS/footer.css">
</head>
<body>
    <header class="site-header">
        <nav class="nav">
            <a href="home.html" class="brand">
                <img src="img/Ticket_icon.png" alt="UTCKET" class="brand__icon">
                <span class="brand__name">UTCKET</span>
            </a>
            <span class="panel-title">Editar Concierto</span>
            <button class="menu-toggle" id="menuToggle" aria-label="Abrir menú">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="menu" id="menu">
                <a href="home.html" class="menu__link">Inicio</a>
                <a href="calendario.html" class="menu__link">Conciertos</a>
                <button id="logoutBtn" class="menu__link btn-salir">Cerrar sesión</button>
            </div>
        </nav>
        <div class="menu-overlay" id="menuOverlay"></div>
    </header>

    <section class="contenedor form-card">
        <h3 class="form-title">Editar Concierto</h3>
        <form id="formEditarConcierto" class="form-grid">
            <div class="form-group">
                <label for="editArtista">Artista</label>
                <input type="text" id="editArtista" required>
            </div>
            <div class="form-group">
                <label for="editFecha">Fecha</label>
                <input type="date" id="editFecha" required>
            </div>
            <div class="form-group">
                <label for="editLugar">Lugar</label>
                <input type="text" id="editLugar" required>
            </div>
            <div class="form-group">
                <label for="editLocalidades">Localidades</label>
                <input type="text" id="editLocalidades" placeholder="VIP, General, Butaca">
            </div>
            <div class="form-group">
                <label for="editPrecios">Precios ($)</label>
                <input type="text" id="editPrecios" placeholder="160, 140, 120">
            </div>
            <div class="form-group full">
                <label for="editImagen">URL de Imagen</label>
                <input type="text" id="editImagen" placeholder="https://...">
            </div>
            <div class="form-actions full">
                <button type="button" id="btnCancelar" class="btn-cancelar">Cancelar</button>
                <button type="submit" class="btn-guardar">Guardar cambios</button>
            </div>
        </form>
    </section>

    <footer class="site-footer">
        <div class="container footer-grid">
            <div class="footer-brand">
                <div class="footer-brand__row">
                    <img src="img/Ticket_icon.png" alt="UTCKET" class="footer-brand__icon">
                    <span class="footer-brand__name">UTCKET</span>
                </div>
                <p class="footer-brand__desc">
                    Los mejores conciertos de la ciudad a tu alcance, más sencillo y fácil.
                    UTCKET es el e-commerce de conciertos que conecta a los fans con los
                    mejores eventos de centroamérica.
                </p>
                <div class="footer-social">
                    <a href="#" aria-label="Facebook" class="footer-social__link">
                        <img src="img/facebook.png" alt="" class="footer-social__icon">
                    </a>
                    <a href="#" aria-label="Twitter" class="footer-social__link">
                        <img src="img/twitter.png" alt="" class="footer-social__icon">
                    </a>
                    <a href="#" aria-label="LinkedIn" class="footer-social__link">
                        <img src="img/linkedin.png" alt="" class="footer-social__icon">
                    </a>
                </div>
            </div>
            <div class="footer-col">
                <h4 class="footer-col__title">Nosotros</h4>
                <p class="footer-col__text">
                    Calle a Comasagua,<br>
                    Carretera al Puerto de la LL, Santa Tecla,<br>
                    La Libertad Sur, El Salvador.
                </p>
            </div>
            <div class="footer-col">
                <h4 class="footer-col__title">Contacto</h4>
                <p class="footer-col__text">
                    <a href="tel:+50376152883" class="footer-link">+(503) 7615 2883</a><br>
                    <a href="mailto:info@utcket.com" class="footer-link">info@utcket.com</a><br>
                    <a href="mailto:ventas@utcket.com" class="footer-link">ventas@utcket.com</a><br><br>
                    NIT: 0614 170306-108-2<br>
                    NRC: 171703-2
                </p>
            </div>
            <div class="footer-subscribe">
                <h4 class="footer-col__title">Suscríbete Y Sé Cliente Preferencial</h4>
                <p class="footer-col__text">
                    Recibe los mejores descuentos para los próximos conciertos o eventos de la región.
                </p>
                <form class="subscribe-form" action="#" method="post" novalidate>
                    <input type="email" name="email" class="subscribe-input" placeholder="Ingresa tu correo" required>
                    <button type="submit" class="subscribe-btn">Suscríbete ahora</button>
                </form>
            </div>
        </div>
        <hr class="footer-sep">
        <div class="container">
            <p class="footer-copy">Copyright © 2025 UTCKET EL SALVADOR, S.A. DE C.V.</p>
        </div>
    </footer>

    <script>
        const menuToggle = document.getElementById("menuToggle");
        const menu = document.getElementById("menu");
        const overlay = document.getElementById("menuOverlay");

        if (menuToggle) {
            menuToggle.addEventListener("click", () => {
                menu.classList.toggle("open");
                overlay.classList.toggle("active");
            });
        }

        if (overlay) {
            overlay.addEventListener("click", () => {
                menu.classList.remove("open");
                overlay.classList.remove("active");
            });
        }
    </script>

    <script type="module">
        import { db } from "./JS/firebase-config.js";
        import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const auth = getAuth();
        const logoutBtn = document.getElementById("logoutBtn");

        onAuthStateChanged(auth, user => {
            if (!user) {
                window.location.href = "login.html";
            }
        });

        if (logoutBtn) {
            logoutBtn.addEventListener("click", async () => {
                try {
                    await signOut(auth);
                    window.location.href = "login.html";
                } catch (error) {
                    console.error(error);
                }
            });
        }

        const params = new URLSearchParams(window.location.search);
        const conciertoId = params.get("id");

        if (!conciertoId) {
            alert("Concierto no encontrado");
            window.location.href = "empleado.html";
        }

        const form = document.getElementById("formEditarConcierto");
        const inputArtista = document.getElementById("editArtista");
        const inputFecha = document.getElementById("editFecha");
        const inputLugar = document.getElementById("editLugar");
        const inputLocalidades = document.getElementById("editLocalidades");
        const inputPrecios = document.getElementById("editPrecios");
        const inputImagen = document.getElementById("editImagen");
        const btnCancelar = document.getElementById("btnCancelar");

        function formatearFechaInput(fecha) {
            if (!fecha) return "";
            try {
                let d;
                if (fecha.seconds) {
                    d = new Date(fecha.seconds * 1000);
                } else {
                    d = new Date(fecha);
                }
                return d.toISOString().slice(0, 10);
            } catch {
                return "";
            }
        }

        async function cargarConcierto() {
            const ref = doc(db, "Conciertos", conciertoId);
            const snap = await getDoc(ref);
            if (!snap.exists()) {
                alert("Concierto no encontrado");
                window.location.href = "empleado.html";
                return;
            }
            const c = snap.data();
            inputArtista.value = c.Artista || c.artista || "";
            inputFecha.value = formatearFechaInput(c.Fecha || c.fecha);
            inputLugar.value = c.Lugar || c.lugar || "";
            if (Array.isArray(c.Localidades)) {
                inputLocalidades.value = c.Localidades.join(", ");
            } else {
                inputLocalidades.value = c.Localidades || "";
            }
            if (Array.isArray(c.Precios)) {
                inputPrecios.value = c.Precios.join(", ");
            } else {
                inputPrecios.value = c.Precios || "";
            }
            inputImagen.value = c.Imagen || c.imagen || "";
        }

        cargarConcierto();

        form.addEventListener("submit", async e => {
            e.preventDefault();

            const artista = inputArtista.value.trim();
            const fecha = inputFecha.value;
            const lugar = inputLugar.value.trim();
            const localidadesRaw = inputLocalidades.value;
            const preciosRaw = inputPrecios.value;
            const imagen = inputImagen.value.trim();

            if (!artista || !fecha || !lugar) {
                alert("Completa al menos artista, fecha y lugar");
                return;
            }

            const localidades = localidadesRaw
                .split(",")
                .map(s => s.trim())
                .filter(s => s.length > 0);

            const precios = preciosRaw
                .split(",")
                .map(s => s.trim())
                .filter(s => s.length > 0);

            const ref = doc(db, "Conciertos", conciertoId);

            const data = {
                Artista: artista,
                Fecha: fecha,
                Lugar: lugar
            };

            if (localidades.length > 0) {
                data.Localidades = localidades;
            }

            if (precios.length > 0) {
                data.Precios = precios;
            }

            if (imagen) {
                data.Imagen = imagen;
            }

            try {
                await updateDoc(ref, data);
                alert("Concierto actualizado correctamente");
                window.location.href = "empleado.html";
            } catch (error) {
                console.error(error);
                alert("Ocurrió un error al actualizar");
            }
        });

        if (btnCancelar) {
            btnCancelar.addEventListener("click", () => {
                window.location.href = "empleado.html";
            });
        }
    </script>
</body>
</html>